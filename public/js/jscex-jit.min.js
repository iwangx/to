!function(){var codeGenerator="function"==typeof eval("(function () {})")?function(a){return a}:function(a){return"false || "+a},stringify="undefined"!=typeof JSON&&JSON.stringify?function(a){return JSON.stringify(a)}:function(){var a=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,b={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return function(c){return a.lastIndex=0,a.test(c)?'"'+c.replace(a,function(a){var c=b[a];return"s"==typeof c?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+c+'"'}}();"undefined"==typeof __jscex__tempVarSeed&&(__jscex__tempVarSeed=0);var init=function(a){function b(a){this._binder=a,this._root=null}function c(a,b,c){this._builderName=a,this._binder=b,this._normalMode=!1,this._indent=c,this._indentLevel=0,this._builderVar="$$_builder_$$_"+__jscex__tempVarSeed++}function d(a){if("call"!=a[0])return!1;var b=a[1];if("name"!=b[0]||"eval"!=b[1])return!1;var c=a[2][0];if(!c||"call"!=c[0])return!1;var d=c[1];if(!d||"dot"!=d[0]||"compile"!=d[2])return!1;var e=d[1];if(!e||"name"!=e[0]||"Jscex"!=e[1])return!1;var f=c[2][0];if(!f||"string"!=f[0])return!1;var g=c[2][1];return g&&"function"==g[0]?!0:!1}function e(d,e){var f=d[2][0][2][0][1],g=d[2][0][2][1],h=a.binders[f],i=new b(h),j=i.generate(g),k=new c(f,h,e),l=k.generate(g[2],j);return l}function f(b,c){var d=c.toString(),f="eval(Jscex.compile("+stringify(b)+", "+d+"))",g=a.parse(f),h=g[1][0][1],i=e(h,0);return a.logger.debug(d+"\n\n>>>\n\n"+i),codeGenerator(i)}a.modules.jit||(b.prototype={generate:function(a){var b=(a[2],a[3]);return this._root={type:"delay",stmts:[]},this._visitStatements(b,this._root.stmts),this._root},_getBindInfo:function(a){var b=a[0];if("stat"==b){var c=a[1];if("call"==c[0]){var d=c[1];if("name"==d[0]&&d[1]==this._binder&&1==c[2].length)return{expression:c[2][0],argName:"",assignee:null}}else if("assign"==c[0]){var e=c[2];if(c=c[3],"call"==c[0]){var d=c[1];if("name"==d[0]&&d[1]==this._binder&&1==c[2].length)return{expression:c[2][0],argName:"$$_result_$$",assignee:e}}}}else if("var"==b){var f=a[1];if(1==f.length){var g=f[0],h=g[0],c=g[1];if(c&&"call"==c[0]){var d=c[1];if("name"==d[0]&&d[1]==this._binder&&1==c[2].length)return{expression:c[2][0],argName:h,assignee:null}}}}else if("return"==b){var c=a[1];if(c&&"call"==c[0]){var d=c[1];if("name"==d[0]&&d[1]==this._binder&&1==c[2].length)return{expression:c[2][0],argName:"$$_result_$$",assignee:"return"}}}return null},_visitStatements:function(a,b,c){if(arguments.length<=2&&(c=0),c>=a.length)return b.push({type:"normal"}),this;var d=a[c],e=this._getBindInfo(d);if(e){var f={type:"bind",info:e};b.push(f),"return"!=e.assignee&&(f.stmts=[],this._visitStatements(a,f.stmts,c+1))}else{var g=d[0];if("return"==g||"break"==g||"continue"==g||"throw"==g)b.push({type:g,stmt:d});else if("if"==g||"try"==g||"for"==g||"do"==g||"while"==g||"switch"==g||"for-in"==g){var h=this._visit(d);if("raw"==h.type)b.push(h),this._visitStatements(a,b,c+1);else{var i=c==a.length-1;if(i)b.push(h);else{var j={type:"combine",first:{type:"delay",stmts:[h]},second:{type:"delay",stmts:[]}};b.push(j),this._visitStatements(a,j.second.stmts,c+1)}}}else b.push({type:"raw",stmt:d}),this._visitStatements(a,b,c+1)}return this},_visit:function(a){function b(){throw new Error('"'+c+'" is not currently supported.')}var c=a[0],d=this._visitors[c];return d?d.call(this,a):void b()},_visitBody:function(a,b){"block"==a[0]?this._visitStatements(a[1],b):this._visitStatements([a],b)},_noBinding:function(a){switch(a[a.length-1].type){case"normal":case"return":case"break":case"throw":case"continue":return!0}return!1},_collectCaseStatements:function(a,b){for(var c=[],d=b;d<a.length;d++)for(var e=a[d][1],f=0;f<e.length;f++){if("break"==e[f][0])return c;c.push(e[f])}return c},_visitors:{"for":function(a){var b=[],c=a[4];if(this._visitBody(c,b),this._noBinding(b))return{type:"raw",stmt:a};var d={type:"delay",stmts:[]},e=a[1];e&&d.stmts.push({type:"raw",stmt:e});var f={type:"loop",bodyFirst:!1,bodyStmt:{type:"delay",stmts:b}};d.stmts.push(f);var g=a[2];g&&(f.condition=g);var h=a[3];return h&&(f.update=h),d},"for-in":function(b){var c=b[4],d=[];if(this._visitBody(c,d),this._noBinding(d))return{type:"raw",stmt:b};var e=__jscex__tempVarSeed++,f="$$_keys_$$_"+e,g="$$_index_$$_"+e,h={type:"delay",stmts:[]},i=a.parse("var "+f+" = Jscex._forInKeys(obj);")[1][0];i[1][0][1][2][0]=b[3],h.stmts.push({type:"raw",stmt:i}),h.stmts.push({type:"raw",stmt:a.parse("var "+g+" = 0;")[1][0]});var j=a.parse(g+" < "+f+".length")[1][0][1],k=a.parse(g+"++")[1][0][1],l={type:"loop",bodyFirst:!1,update:k,condition:j,bodyStmt:{type:"delay",stmts:[]}};h.stmts.push(l);var m=b[2][1];return"var"==b[1][0]?l.bodyStmt.stmts.push({type:"raw",stmt:a.parse("var "+m+" = "+f+"["+g+"];")[1][0]}):l.bodyStmt.stmts.push({type:"raw",stmt:a.parse(m+" = "+f+"["+g+"];")[1][0]}),this._visitBody(c,l.bodyStmt.stmts),h},"while":function(a){var b=[],c=a[2];if(this._visitBody(c,b),this._noBinding(b))return{type:"raw",stmt:a};var d={type:"loop",bodyFirst:!1,bodyStmt:{type:"delay",stmts:b}},e=a[1];return d.condition=e,d},"do":function(a){var b=[],c=a[2];if(this._visitBody(c,b),this._noBinding(b))return{type:"raw",stmt:a};var d={type:"loop",bodyFirst:!0,bodyStmt:{type:"delay",stmts:b}},e=a[1];return d.condition=e,d},"switch":function(a){for(var b=!0,c={type:"switch",item:a[1],caseStmts:[]},d=a[2],e=0;e<d.length;e++){var f={item:d[e][0],stmts:[]};c.caseStmts.push(f);var g=this._collectCaseStatements(d,e);this._visitStatements(g,f.stmts),b=b&&this._noBinding(f.stmts)}return b?{type:"raw",stmt:a}:c},"if":function(a){for(var b=!0,c={type:"if",conditionStmts:[]},d=a;;){var e=d[1],f={cond:e,stmts:[]};c.conditionStmts.push(f);var g=d[2];this._visitBody(g,f.stmts),b=b&&this._noBinding(f.stmts);var h=d[3];if(!h||"if"!=h[0])break;d=h}var h=d[3];return h&&(c.elseStmts=[],this._visitBody(h,c.elseStmts),b=b&&this._noBinding(c.elseStmts)),b?{type:"raw",stmt:a}:c},"try":function(a,b){var c=[],d=a[1];this._visitStatements(d,c);var e=this._noBinding(c),f={type:"try",bodyStmt:{type:"delay",stmts:c}},g=a[2];if(g){var h=g[0];f.exVar=h,f.catchStmts=[],this._visitStatements(g[1],f.catchStmts),e=e&&this._noBinding(f.catchStmts)}var i=a[3];return i&&(f.finallyStmt={type:"delay",stmts:[]},this._visitStatements(i,f.finallyStmt.stmts),e=e&&this._noBinding(f.finallyStmt.stmts)),e?{type:"raw",stmt:a}:f}}},c.prototype={_write:function(a){return this._buffer.push(a),this},_writeLine:function(a){return this._write(a)._write("\n"),this},_writeIndents:function(){for(var a=0;a<this._indent;a++)this._write(" ");for(var a=0;a<this._indentLevel;a++)this._write("    ");return this},generate:function(a,b){return this._buffer=[],this._writeLine("(function ("+a.join(", ")+") {"),this._indentLevel++,this._writeIndents()._writeLine("var "+this._builderVar+" = Jscex.builders["+stringify(this._builderName)+"];"),this._writeIndents()._writeLine("return "+this._builderVar+".Start(this,"),this._indentLevel++,this._pos={},this._writeIndents()._visitJscex(b)._writeLine(),this._indentLevel--,this._writeIndents()._writeLine(");"),this._indentLevel--,this._writeIndents()._write("})"),this._buffer.join("")},_visitJscex:function(a){return this._jscexVisitors[a.type].call(this,a),this},_visitRaw:function(a){function b(){throw new Error('"'+c+'" is not currently supported.')}var c=a[0],d=this._rawVisitors[c];return d?d.call(this,a):b(),this},_visitJscexStatements:function(a){for(var b=0;b<a.length;b++){var c=a[b];"raw"==c.type||"if"==c.type||"switch"==c.type?this._writeIndents()._visitJscex(c)._writeLine():"delay"==c.type?this._visitJscexStatements(c.stmts):this._writeIndents()._write("return ")._visitJscex(c)._writeLine(";")}},_visitRawStatements:function(a){for(var b=0;b<a.length;b++){var c=a[b];switch(this._writeIndents()._visitRaw(c)._writeLine(),c[0]){case"break":case"return":case"continue":case"throw":return}}},_visitRawBody:function(a){return"block"==a[0]?this._visitRaw(a):(this._writeLine(),this._indentLevel++,this._writeIndents()._visitRaw(a),this._indentLevel--),this},_visitRawFunction:function(a){var b=a[1]||"",c=a[2],d=a[3];this._writeLine("function "+b+"("+c.join(", ")+") {"),this._indentLevel++;var e=this._pos.inFunction;this._pos.inFunction=!0,this._visitRawStatements(d),this._indentLevel--,this._pos.inFunction=e,this._writeIndents()._write("}")},_jscexVisitors:{delay:function(a){if(1==a.stmts.length){var b=a.stmts[0];switch(b.type){case"delay":case"combine":case"normal":case"break":case"continue":case"loop":case"try":return void this._visitJscex(b);case"return":if(!b.stmt[1])return void this._visitJscex(b)}}this._writeLine(this._builderVar+".Delay(function () {"),this._indentLevel++,this._visitJscexStatements(a.stmts),this._indentLevel--,this._writeIndents()._write("})")},combine:function(a){this._writeLine(this._builderVar+".Combine("),this._indentLevel++,this._writeIndents()._visitJscex(a.first)._writeLine(","),this._writeIndents()._visitJscex(a.second)._writeLine(),this._indentLevel--,this._writeIndents()._write(")")},loop:function(a){this._writeLine(this._builderVar+".Loop("),this._indentLevel++,a.condition?(this._writeIndents()._writeLine("function () {"),this._indentLevel++,this._writeIndents()._write("return ")._visitRaw(a.condition)._writeLine(";"),this._indentLevel--,this._writeIndents()._writeLine("},")):this._writeIndents()._writeLine("null,"),a.update?(this._writeIndents()._writeLine("function () {"),this._indentLevel++,this._writeIndents()._visitRaw(a.update)._writeLine(";"),this._indentLevel--,this._writeIndents()._writeLine("},")):this._writeIndents()._writeLine("null,"),this._writeIndents()._visitJscex(a.bodyStmt)._writeLine(","),this._writeIndents()._writeLine(a.bodyFirst),this._indentLevel--,this._writeIndents()._write(")")},raw:function(a){this._visitRaw(a.stmt)},bind:function(a){var b=a.info;this._write(this._builderVar+".Bind(")._visitRaw(b.expression)._writeLine(", function ("+b.argName+") {"),this._indentLevel++,"return"==b.assignee?this._writeIndents()._writeLine("return "+this._builderVar+".Return("+b.argName+");"):(b.assignee&&this._writeIndents()._visitRaw(b.assignee)._writeLine(" = "+b.argName+";"),this._visitJscexStatements(a.stmts)),this._indentLevel--,this._writeIndents()._write("})")},"if":function(a){for(var b=0;b<a.conditionStmts.length;b++){var c=a.conditionStmts[b];this._write("if (")._visitRaw(c.cond)._writeLine(") {"),this._indentLevel++,this._visitJscexStatements(c.stmts),this._indentLevel--,this._writeIndents()._write("} else ")}this._writeLine("{"),this._indentLevel++,a.elseStmts?this._visitJscexStatements(a.elseStmts):this._writeIndents()._writeLine("return "+this._builderVar+".Normal();"),this._indentLevel--,this._writeIndents()._write("}")},"switch":function(a){this._write("switch (")._visitRaw(a.item)._writeLine(") {"),this._indentLevel++;for(var b=0;b<a.caseStmts.length;b++){var c=a.caseStmts[b];c.item?this._writeIndents()._write("case ")._visitRaw(c.item)._writeLine(":"):this._writeIndents()._writeLine("default:"),this._indentLevel++,this._visitJscexStatements(c.stmts),this._indentLevel--}this._writeIndents()._write("}")},"try":function(a){this._writeLine(this._builderVar+".Try("),this._indentLevel++,this._writeIndents()._visitJscex(a.bodyStmt)._writeLine(","),a.catchStmts?(this._writeIndents()._writeLine("function ("+a.exVar+") {"),this._indentLevel++,this._visitJscexStatements(a.catchStmts),this._indentLevel--,this._writeIndents()._writeLine("},")):this._writeIndents()._writeLine("null,"),a.finallyStmt?this._writeIndents()._visitJscex(a.finallyStmt)._writeLine():this._writeIndents()._writeLine("null"),this._indentLevel--,this._writeIndents()._write(")")},normal:function(a){this._write(this._builderVar+".Normal()")},"throw":function(a){this._write(this._builderVar+".Throw(")._visitRaw(a.stmt[1])._write(")")},"break":function(a){this._write(this._builderVar+".Break()")},"continue":function(a){this._write(this._builderVar+".Continue()")},"return":function(a){this._write(this._builderVar+".Return("),a.stmt[1]&&this._visitRaw(a.stmt[1]),this._write(")")}},_rawVisitors:{"var":function(a){this._write("var ");for(var b=a[1],c=0;c<b.length;c++)this._write(b[c][0]),b[c].length>1&&this._write(" = ")._visitRaw(b[c][1]),c<b.length-1&&this._write(", ");this._write(";")},seq:function(a){for(var b=1;b<a.length;b++)this._visitRaw(a[b]),b<a.length-1&&this._write(", ")},binary:function(a){function b(a){var b=a[0];return!("num"==b||"name"==b||"dot"==b)}var c=a[1],d=a[2],e=a[3];b(d)?this._write("(")._visitRaw(d)._write(") "):this._visitRaw(d)._write(" "),this._write(c),b(e)?this._write(" (")._visitRaw(e)._write(")"):this._write(" ")._visitRaw(e)},sub:function(a){function b(){return!("name"==c[0])}var c=a[1],d=a[2];b()?this._write("(")._visitRaw(c)._write(")[")._visitRaw(d)._write("]"):this._visitRaw(c)._write("[")._visitRaw(d)._write("]")},"unary-postfix":function(a){var b=a[1],c=a[2];this._visitRaw(c)._write(b)},"unary-prefix":function(a){var b=a[1],c=a[2];this._write(b),"typeof"==b?this._write("(")._visitRaw(c)._write(")"):this._visitRaw(c)},assign:function(a){var b=a[1],c=a[2],d=a[3];this._visitRaw(c),"string"==typeof b?this._write(" "+b+"= "):this._write(" = "),this._visitRaw(d)},stat:function(a){this._visitRaw(a[1])._write(";")},dot:function(a){function b(){var b=a[1][0];return!("dot"==b||"name"==b)}b()?this._write("(")._visitRaw(a[1])._write(").")._write(a[2]):this._visitRaw(a[1])._write(".")._write(a[2])},"new":function(a){var b=a[1];this._write("new ")._visitRaw(b)._write("(");for(var c=a[2],d=0,e=c.length;e>d;d++)this._visitRaw(c[d]),e-1>d&&this._write(", ");this._write(")")},call:function(a){if(d(a)){var b=this._indent+4*this._indentLevel,c=e(a,b);this._write(c)}else{var f="name"==a[1][0]&&a[1][1]==this._binder;f&&(this._pos={inFunction:!0},this._buffer=[]),this._visitRaw(a[1])._write("(");for(var g=a[2],h=0;h<g.length;h++)this._visitRaw(g[h]),h<g.length-1&&this._write(", ");if(this._write(")"),f)throw"Invalid bind operation: "+this._buffer.join("")}},name:function(a){this._write(a[1])},object:function(a){var b=a[1];if(b.length<=0)this._write("{ }");else{this._writeLine("{"),this._indentLevel++;for(var c=0;c<b.length;c++)this._writeIndents()._write(stringify(b[c][0])+": ")._visitRaw(b[c][1]),c<b.length-1?this._writeLine(","):this._writeLine("");this._indentLevel--,this._writeIndents()._write("}")}},array:function(a){this._write("[");for(var b=a[1],c=0;c<b.length;c++)this._visitRaw(b[c]),c<b.length-1&&this._write(", ");this._write("]")},num:function(a){this._write(a[1])},regexp:function(a){this._write("/"+a[1]+"/"+a[2])},string:function(a){this._write(stringify(a[1]))},"function":function(a){this._visitRawFunction(a)},defun:function(a){this._visitRawFunction(a)},"return":function(a){if(this._pos.inFunction){this._write("return");var b=a[1];b&&this._write(" ")._visitRaw(b),this._write(";")}else this._write("return ")._visitJscex({type:"return",stmt:a})._write(";")},"for":function(a){this._write("for (");var b=a[1];b?(this._visitRaw(b),"var"!=b[0]?this._write("; "):this._write(" ")):this._write("; ");var c=a[2];c&&this._visitRaw(c),this._write("; ");var d=a[3];d&&this._visitRaw(d),this._write(") ");var e=this._pos.inLoop;this._pos.inLoop=!0;var f=a[4];this._visitRawBody(f),this._pos.inLoop=e},"for-in":function(a){this._write("for (");var b=a[1];"var"==b[0]?this._write("var "+b[1][0][0]):this._visitRaw(b),this._write(" in ")._visitRaw(a[3])._write(") ");var c=a[4];this._visitRawBody(c)},block:function(a){this._writeLine("{"),this._indentLevel++,this._visitRawStatements(a[1]),this._indentLevel--,this._writeIndents()._write("}")},"while":function(a){var b=a[1],c=a[2],d=this._pos.inLoop;this._pos.inLoop=!0,this._write("while (")._visitRaw(b)._write(") ")._visitRawBody(c),this._pos.inLoop=d},"do":function(a){var b=a[1],c=a[2],d=this._pos.inLoop;this._pos.inLoop=!0,this._write("do ")._visitRawBody(c),this._pos.inLoop=d,"block"==c[0]?this._write(" "):this._writeLine()._writeIndents(),this._write("while (")._visitRaw(b)._write(");")},"if":function(a){var b=a[1],c=a[2];this._write("if (")._visitRaw(b)._write(") ")._visitRawBody(c);var d=a[3];d&&("block"==c[0]?this._write(" "):this._writeLine("")._writeIndents(),"if"==d[0]?this._write("else ")._visitRaw(d):this._write("else ")._visitRawBody(d))},"break":function(a){this._pos.inLoop||this._pos.inSwitch?this._write("break;"):this._write("return ")._visitJscex({type:"break",stmt:a})._write(";")},"continue":function(a){this._pos.inLoop?this._write("continue;"):this._write("return ")._visitJscex({type:"continue",stmt:a})._write(";")},"throw":function(a){var b=this._pos;b.inTry||b.inFunction?this._write("throw ")._visitRaw(a[1])._write(";"):this._write("return ")._visitJscex({type:"throw",stmt:a})._write(";")},conditional:function(a){this._write("(")._visitRaw(a[1])._write(") ? (")._visitRaw(a[2])._write(") : (")._visitRaw(a[3])._write(")")},"try":function(a){this._writeLine("try {"),this._indentLevel++;var b=this._pos.inTry;this._pos.inTry=!0,this._visitRawStatements(a[1]),this._indentLevel--,this._pos.inTry=b;var c=a[2],d=a[3];c&&(this._writeIndents()._writeLine("} catch ("+c[0]+") {"),this._indentLevel++,this._visitRawStatements(c[1]),this._indentLevel--),d&&(this._writeIndents()._writeLine("} finally {"),this._indentLevel++,this._visitRawStatements(d),this._indentLevel--),this._writeIndents()._write("}")},"switch":function(a){this._write("switch (")._visitRaw(a[1])._writeLine(") {"),this._indentLevel++;var b=this._pos.inSwitch;this._pos.inSwitch=!0;for(var c=a[2],d=0;d<c.length;d++){var e=c[d];this._writeIndents(),e[0]?this._write("case ")._visitRaw(e[0])._writeLine(":"):this._writeLine("default:"),this._indentLevel++,this._visitRawStatements(e[1]),this._indentLevel--}this._indentLevel--,this._pos.inSwitch=b,this._writeIndents()._write("}")}}},a.compile=f,a.modules.jit=!0)},isCommonJS="undefined"!=typeof require&&"undefined"!=typeof module&&module.exports,isAmd="undefined"!=typeof define&&define.amd;if(isCommonJS)module.exports.init=function(a){a.modules.parser||require("./jscex-parser").init(a),init(a)};else if(isAmd)define("jscex-jit",["jscex-parser"],function(a){return{init:function(b){b.modules.parser||a.init(b),init(b)}}});else{if("undefined"==typeof Jscex)throw new Error('Missing root object, please load "jscex" module first.');if(!Jscex.modules.parser)throw new Error('Missing essential components, please initialize "parser" module first.');init(Jscex)}}();